{{define "title"}}Products – Admin{{end}}

{{define "content"}}
<div class="account-page">
    <aside class="account-sidebar">
        <div class="account-sidebar-profile">
            <div class="account-avatar">A</div>
            <div class="account-sidebar-name">Administrator</div>
            <span class="account-role-badge badge-admin">Admin</span>
        </div>
        <nav class="account-nav">
            <a href="/admin/dashboard" class="account-nav-link">
                <i data-lucide="layout-dashboard"></i> Dashboard
            </a>
            <a href="/admin/orders" class="account-nav-link">
                <i data-lucide="package"></i> Orders
            </a>
            <a href="/admin/products" class="account-nav-link active">
                <i data-lucide="shopping-bag"></i> Products
            </a>
            <a href="/admin/users" class="account-nav-link">
                <i data-lucide="users"></i> Users
            </a>
            <a href="/admin/analytics" class="account-nav-link">
                <i data-lucide="bar-chart-3"></i> Analytics
            </a>
            <div class="account-nav-divider"></div>
            <a href="/account" class="account-nav-link">
                <i data-lucide="user"></i> My Account
            </a>
            <a href="/auth/logout" class="account-nav-link nav-link-danger">
                <i data-lucide="log-out"></i> Logout
            </a>
        </nav>
    </aside>

    <main class="account-main" style="max-width:1200px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
            <h1 class="account-section-title" style="font-size:24px;margin-bottom:0;">
                <i data-lucide="shopping-bag"></i> Products
            </h1>
            <button id="add-product-btn" class="btn" style="display:flex;align-items:center;gap:8px;">
                <i data-lucide="plus" style="width:16px;height:16px;"></i> Add Product
            </button>
        </div>

        <div style="background:white;border-radius:12px;padding:24px;border:1px solid var(--color-border);">
            <table style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr style="text-align:left;border-bottom:2px solid #eee;">
                        <th style="padding:12px 0;">Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Sizes</th>
                        <th>Colors</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Products}}
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:12px 0;">
                            <div style="width:50px;height:60px;background:#f5f5f5;border-radius:4px;overflow:hidden;">
                                {{if .Images}}
                                <img src="{{index .Images 0}}" style="width:100%;height:100%;object-fit:cover;"
                                    onerror="this.parentElement.style.background='#f5f5f5'">
                                {{end}}
                            </div>
                        </td>
                        <td style="font-weight:500;">{{.Name}}</td>
                        <td style="color:var(--color-text-muted);">{{.Category}}</td>
                        <td style="font-weight:600;">${{printf "%.2f" .Price}}</td>
                        <td style="font-size:12px;">
                            {{range .Sizes}}
                            <span
                                style="background:#f5f5f5;padding:2px 6px;border-radius:4px;margin-right:4px;">{{.}}</span>
                            {{end}}
                        </td>
                        <td style="font-size:12px;">
                            {{range .Colors}}
                            <span
                                style="display:inline-block;width:16px;height:16px;border-radius:50%;border:1px solid #ddd;margin-right:4px;background:{{.}};"
                                title="{{.}}"></span>
                            {{end}}
                        </td>
                        <td style="font-size:12px;">
                            {{$total := 0}}
                            {{range $size, $qty := .StockBySize}}
                            {{$total = $qty}}
                            {{end}}
                            {{if .StockBySize}}
                            <span style="color:var(--color-success);">In Stock</span>
                            {{else}}
                            <span style="color:var(--color-text-muted);">N/A</span>
                            {{end}}
                        </td>
                        <td>
                            {{if .IsActive}}
                            <span
                                style="background:#ecfdf5;color:#10b981;padding:4px 8px;border-radius:4px;font-size:11px;">Active</span>
                            {{else}}
                            <span
                                style="background:#fef2f2;color:#ef4444;padding:4px 8px;border-radius:4px;font-size:11px;">Inactive</span>
                            {{end}}
                        </td>
                        <td>
                            <div style="display:flex;gap:8px;">
                                <a href="/product/{{.ID}}" target="_blank" style="color:var(--color-text-muted);"
                                    title="View">
                                    <i data-lucide="external-link" style="width:16px;height:16px;"></i>
                                </a>
                                <button class="edit-product-btn" data-product-id="{{.ID}}"
                                    style="background:none;border:none;cursor:pointer;color:var(--color-accent);"
                                    title="Edit">
                                    <i data-lucide="edit" style="width:16px;height:16px;"></i>
                                </button>
                                <button class="delete-product-btn" data-product-id="{{.ID}}"
                                    style="background:none;border:none;cursor:pointer;color:var(--color-danger);"
                                    title="Delete">
                                    <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{if not .Products}}<p style="color:var(--color-text-muted);text-align:center;padding:24px;">No products
                found</p>{{end}}
        </div>

        <div id="product-modal"
            style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.55);align-items:center;justify-content:center;z-index:2100;">
            <div
                style="background:white;border-radius:12px;padding:24px;width:100%;max-width:560px;box-shadow:0 20px 40px rgba(15,23,42,0.2);">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
                    <h2 id="product-modal-title" style="margin:6px 0 0;font-size:18px;">Add Product</h2>
                    <button id="close-product-modal" type="button"
                        style="background:none;border:none;font-size:20px;cursor:pointer;">×</button>
                </div>
                <form id="add-product-form" style="display:grid;gap:12px;">
                    <input type="hidden" id="product-id" name="product_id">
                    <div class="form-group">
                        <label>Name *</label>
                        <input class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input class="form-input" name="price" type="number" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input class="form-input" name="category" placeholder="Shoes, Jackets">
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <input class="form-input" name="gender" placeholder="men, women">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-input" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Sizes (comma separated)</label>
                        <input class="form-input" name="sizes" placeholder="S,M,L">
                    </div>
                    <div class="form-group">
                        <label>Colors (comma separated)</label>
                        <input class="form-input" name="colors" placeholder="black,white,#ff0000">
                    </div>
                    <div class="form-group">
                        <label>Stock (size:qty comma separated)</label>
                        <input class="form-input" name="stock" placeholder="S:10,M:5,L:2">
                    </div>
                    <div class="form-group">
                        <label>Image *</label>
                        <input class="form-input" name="image" type="file" accept="image/*">
                        <p style="font-size: 11px; color: var(--color-text-muted); margin-top: 4px;">Or provide a comma
                            separated list of remote URLs below</p>
                        <input class="form-input" name="images" placeholder="https://...">
                    </div>
                    <div id="add-product-error" style="display:none;color:var(--color-danger);font-size:12px;"></div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;">
                        <button id="cancel-product-btn" type="button" class="btn"
                            style="background:#e2e8f0;color:#0f172a;">Cancel</button>
                        <button id="product-submit-btn" type="submit" class="btn">Create</button>
                    </div>
                </form>
            </div>
        </div>

        <div
            style="margin-top:24px;padding:16px;background:#f9f9f9;border-radius:8px;font-size:13px;color:var(--color-text-muted);">
            <strong>API Endpoints:</strong><br>
            <code>POST /api/product</code> - Create new product<br>
            <code>PUT /api/product/:id</code> - Update product<br>
            <code>DELETE /api/product/:id</code> - Delete product
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const productId = btn.dataset.productId;
                if (!confirm('Are you sure you want to delete this product?')) return;
                try {
                    const res = await fetch(`/api/product/${productId}`, { method: 'DELETE' });
                    if (res.ok) {
                        location.reload();
                    } else {
                        alert('Failed to delete product');
                    }
                } catch (err) {
                    alert('Failed to delete product');
                }
            });
        });

        const addProductBtn = document.getElementById('add-product-btn');
        const productModal = document.getElementById('product-modal');
        const closeProductModal = document.getElementById('close-product-modal');
        const cancelProductBtn = document.getElementById('cancel-product-btn');
        const addProductForm = document.getElementById('add-product-form');
        const addProductError = document.getElementById('add-product-error');
        const modalTitle = document.getElementById('product-modal-title');
        const productSubmitBtn = document.getElementById('product-submit-btn');
        const productIdInput = document.getElementById('product-id');

        function openProductModal(mode) {
            if (!productModal) return;
            productModal.style.display = 'flex';
            addProductError.style.display = 'none';
            productModal.dataset.mode = mode;
            if (modalTitle) {
                modalTitle.textContent = mode === 'edit' ? 'Edit Product' : 'Add Product';
            }
            if (productSubmitBtn) {
                productSubmitBtn.textContent = mode === 'edit' ? 'Save' : 'Create';
            }
            if (mode === 'create') {
                addProductForm.reset();
                if (productIdInput) productIdInput.value = '';
            }
        }

        function closeProductModalView() {
            if (productModal) productModal.style.display = 'none';
        }

        addProductBtn?.addEventListener('click', () => openProductModal('create'));
        closeProductModal?.addEventListener('click', closeProductModalView);
        cancelProductBtn?.addEventListener('click', closeProductModalView);
        productModal?.addEventListener('click', e => {
            if (e.target === productModal) closeProductModalView();
        });

        function parseCsv(value) {
            return value.split(',').map(item => item.trim()).filter(Boolean);
        }

        function parseStock(value) {
            const stock = {};
            parseCsv(value).forEach(entry => {
                const parts = entry.split(':');
                if (parts.length < 2) return;
                const size = parts[0].trim();
                const qty = parseInt(parts[1].trim(), 10);
                if (!size || Number.isNaN(qty)) return;
                stock[size] = qty;
            });
            return stock;
        }

        function normalizeGender(value) {
            const v = value.trim().toLowerCase();
            if (v === 'men' || v === 'male' || v === 'man') return 'men';
            if (v === 'women' || v === 'female' || v === 'woman') return 'women';
            return '';
        }

        function toCsv(value) {
            return Array.isArray(value) ? value.join(', ') : '';
        }

        function toStockCsv(stock) {
            if (!stock) return '';
            return Object.entries(stock).map(([size, qty]) => `${size}:${qty}`).join(', ');
        }

        function setFormValue(name, value) {
            const field = addProductForm.querySelector(`[name="${name}"]`);
            if (field) field.value = value || '';
        }
        document.querySelectorAll('.edit-product-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const productId = btn.dataset.productId;
                if (!productId) return;
                try {
                    const res = await fetch(`/api/product/${productId}`);
                    if (!res.ok) throw new Error('load');
                    const product = await res.json();
                    openProductModal('edit');
                    if (productIdInput) productIdInput.value = product.id || productId;
                    setFormValue('name', product.name);
                    setFormValue('price', product.price);
                    setFormValue('category', product.category);
                    setFormValue('gender', product.gender);
                    setFormValue('description', product.description);
                    setFormValue('sizes', toCsv(product.sizes));
                    setFormValue('colors', toCsv(product.colors));
                    setFormValue('images', toCsv(product.images));
                    setFormValue('stock', toStockCsv(product.stock_by_size));
                } catch (err) {
                    alert('Failed to load product');
                }
            });
        });

        // Auto-formatting for Stock field
        const stockField = addProductForm.querySelector('[name="stock"]');
        if (stockField) {
            stockField.addEventListener('input', function (e) {
                let val = this.value;
                const segments = val.split(',').map(s => s.trimStart());
                let lastSegment = segments[segments.length - 1];

                // If it's a known size and doesn't have a colon, add it
                const sizes = ['S', 'M', 'L', 'XL', 'XXL', 'XS'];
                if (sizes.includes(lastSegment.toUpperCase()) && !lastSegment.includes(':')) {
                    segments[segments.length - 1] = lastSegment.toUpperCase() + ':';
                    this.value = segments.join(', ');
                }
            });
        }

        addProductForm?.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(addProductForm);
            const productId = (productIdInput?.value || '').trim();
            const isEdit = productId !== '';

            // Frontend Validation
            const name = (formData.get('name') || '').toString().trim();
            const price = parseFloat(formData.get('price'));
            const category = (formData.get('category') || '').toString().trim();
            const gender = (formData.get('gender') || '').toString().trim();
            const description = (formData.get('description') || '').toString().trim();
            const sizesVal = (formData.get('sizes') || '').toString().trim();
            const colorsVal = (formData.get('colors') || '').toString().trim();
            const stockVal = (formData.get('stock') || '').toString().trim();
            const imageFile = formData.get('image');

            // Validation Patterns
            const letterDigitPattern = /^[\w\sа-яА-ЯёЁ,.!?-]+$/;
            const letterPattern = /^[a-zA-Zа-яА-ЯёЁ\s]+$/;

            if (!name || !letterDigitPattern.test(name)) {
                addProductError.textContent = 'Name is required and should contain only letters and digits';
                addProductError.style.display = 'block';
                return;
            }
            if (Number.isNaN(price) || price <= 0) {
                addProductError.textContent = 'Valid price is required';
                addProductError.style.display = 'block';
                return;
            }
            if (category && !letterPattern.test(category)) {
                addProductError.textContent = 'Category should contain only letters';
                addProductError.style.display = 'block';
                return;
            }
            if (gender && !letterPattern.test(gender)) {
                addProductError.textContent = 'Gender should contain only letters';
                addProductError.style.display = 'block';
                return;
            }
            if (description && !letterDigitPattern.test(description)) {
                addProductError.textContent = 'Description should contain only letters and digits';
                addProductError.style.display = 'block';
                return;
            }
            if (colorsVal && !letterPattern.test(colorsVal.replace(/,/g, ''))) {
                addProductError.textContent = 'Colors should contain only letters';
                addProductError.style.display = 'block';
                return;
            }

            if (!isEdit && (!imageFile || imageFile.size === 0)) {
                const remoteImages = (formData.get('images') || '').toString().trim();
                if (!remoteImages) {
                    addProductError.textContent = 'Image is required';
                    addProductError.style.display = 'block';
                    return;
                }
            }

            addProductError.style.display = 'none';

            if (!isEdit) {
                // Use FormData for multipart/form-data upload when creating
                try {
                    const res = await fetch('/api/product', {
                        method: 'POST',
                        body: formData, // FormData automatically sets correct Content-Type with boundary
                    });
                    if (res.ok) {
                        location.reload();
                        return;
                    }
                    let msg = 'Failed to create product';
                    const data = await res.json().catch(() => ({}));
                    if (data && data.error) msg = data.error;
                    addProductError.textContent = msg;
                    addProductError.style.display = 'block';
                } catch (err) {
                    addProductError.textContent = 'Failed to create product';
                    addProductError.style.display = 'block';
                }
            } else {
                // Keep JSON for updates for now, or adapt server to handle multipart for PUT/PATCH
                const payload = {
                    name: name,
                    description: (formData.get('description') || '').toString().trim(),
                    category: (formData.get('category') || '').toString().trim(),
                    gender: normalizeGender((formData.get('gender') || '').toString()),
                    price,
                    sizes: parseCsv((formData.get('sizes') || '').toString()),
                    colors: parseCsv((formData.get('colors') || '').toString()),
                    images: parseCsv((formData.get('images') || '').toString()),
                    stock_by_size: parseStock((formData.get('stock') || '').toString()),
                };
                try {
                    const res = await fetch(`/api/product/${productId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (res.ok) {
                        location.reload();
                        return;
                    }
                    let msg = 'Failed to update product';
                    const data = await res.json().catch(() => ({}));
                    if (data && data.error) msg = data.error;
                    addProductError.textContent = msg;
                    addProductError.style.display = 'block';
                } catch (err) {
                    addProductError.textContent = 'Failed to update product';
                    addProductError.style.display = 'block';
                }
            }
        });
    });
</script>
{{end}}